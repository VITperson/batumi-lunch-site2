# Дорожная карта «Планировщик недели»

## Итерация 1 — MVP «Планировщик недели» (1–1.5 спринта)

### Цели
- Один экран выбора и оформления заказа на ближайшую неделю без переходов по дням.
- Пресеты (минимальный набор) и гостевой чек-аут.
- Единоразовая оплата за одну неделю.

### Основные фичи
1. **Планировщик недели (S1, S2, S3)**
   - Переключатель недели: ближайшая доступная по умолчанию, стрелки + выпадающий список недель (данные `/menu/weeks`).
   - Грид Пн–Пт с карточками дня: фото, список блюд, цена/итог, чекбокс + селектор порций (1–8).
   - Состояния дня: доступен, sold-out (disabled), закрыт по дедлайну (disabled с тултипом).
2. **Sticky сводка заказа**
   - Список выбранных дней + количество порций.
   - Быстрые пресеты (конфигурируемый список в админке; на MVP достаточно 2–3): «Пн–Пт», «Пн–Ср–Пт».
   - Автопересчёт итоговой стоимости, текст «Доставка уже включена».
3. **Форма оформления**
   - Адрес (обязателен) + проверка зоны доставки (базовый сценарий: текущая зона, без редактора).
   - Поле промокода (валидация + расчёт скидки «максимальная из»).
   - FAQ блок со статикой («без замен», «как работает доставка»).
   - CTA «Оформить X порций за Y ₾» → переход к текущему checkout-потоку.
4. **Гостевой чек-аут (S7)**
   - Ввод телефона + SMS-код вместо регистрации.
   - Сохранение адреса/телефона в профиле после успешной оплаты.

### Бэкенд
- Расширить доменную модель: `DayOffer` (аллергены, калории, фото), лимиты порций, статусы sold-out/closed.
- Endpoint для недель (`GET /menu/weeks` уже есть), доделать выдачу калорий/аллергенов.
- Endpoint для расчёта корзины: принимает выбранные дни/порции, возвращает цену, статусы, ошибки.
- АPI для пресетов (CRUD в админке, на клиент — `GET /presets`).
- Адрес/зоны доставки: базовая проверка (на MVP — ручной список зон в конфиге/БД).

### UI/Дизайн
- Макеты десктоп/мобайл 360–430px.
- Тайпскейл и цветовая схема из текущего бренда.
- Фокус-стили, full keyboard control.

### Технические задачи
- Сохранение выбора в localStorage до оплаты.
- Обновление аналитики: события выбора дня/порций/пресета.
- Миграции БД для новых полей: `DayOffer` (калории, аллергенные метки, бейджи), лимиты порций, статусы.

---

## Итерация 2 — Многонедельный заказ (1–1.5 спринта)

### Цели
- Возможность оформить заказ сразу на несколько недель (до N=8) с единоразовой оплатой.
- Ведение шаблонов повторения дней.

### Основные фичи
1. **Расширение сводки**
   - Ползунок/счетчик «Количество недель вперёд» (1–8).
   - Тоггл «Повторять выбранные дни» + ссылка «Просмотреть недели».
2. **Модальное окно «Настроить недели»**
   - Список будущих недель с их меню (если меню не опубликовано — state «Меню уточняется»).
   - Возможность для каждой недели скорректировать дни/порции или снять неделю.
3. **Расчёт корзины и биллинг**
   - API возвращает помесячный/помесячный (по неделям) breakdown и общую сумму.
   - Правила: если неделя без меню — бронирование с пометкой «цена уточняется» либо «заморозить цену» (настройка).

### Бэкенд
- Таблицы/сущности для многонедельного заказа: `OrderTemplate`, `WeekSelection`, хранение статуса меню на будущую неделю.
- Расширение checkout API: принимает массив недель, проверяет дедлайны/лимиты.
- Уведомление пользователю, если меню изменилось после бронирования (подготовка к итерации 3).

### UI
- Sticky summary обновляется с многонедельной суммой.
- На мобайле — аккуратные переходы (модалка полноэкранная).

---

## Итерация 3 — Подписка с автопродлением (≈2 спринта)

### Цели
- Ввести подписку «повторять заказ каждую неделю» с автосписаниями и пропусками.

### Основные фичи
1. **Тоггл подписки**
   - В сводке переключение «Подписка» vs «Многонедельный заказ» (взаимоисключающие режимы).
   - При включении — показ экономии, расписания списаний.
2. **Управление подпиской**
   - В checkout собираем токен платежа (Apple Pay/Google Pay/карта) для еженедельных списаний.
   - В ЛК/после оплаты: действия «Пропустить неделю», «Пауза», «Изменить со следующей недели», «Отмена» (с дедлайном).
   - Уведомления T-24, T-0, фейлы списаний → пауза + письмо.

### Бэкенд
- Сущности `Subscription`, `SubscriptionWeek`, хранение токена платежа (у провайдера), график списаний.
- Сервис подписок: cron/worker для списаний, уведомлений, пропусков.
- Валидация дедлайнов (конфиг из админки).

### UI
- В планировщике — состояние подписки (активна/пауза), подсказки.
- Checkout — ясная коммуникация стоимости, расписания списаний, условий отмены.

---

## Итерация 4 — Личный кабинет и повторы (≈1 спринт)

### Цели
- Дать пользователю управление адресами, слоты доставки, история заказов, повтор предыдущего заказа в 1 клик.

### Основные фичи
1. **История заказов**
   - Список предыдущих недель, кнопка «Повторить» (S6).
   - Детали заказа: дни, порции, статус, квитанция.
2. **Адреса и слоты**
   - CRUD адресов, проверка зон.
   - Выбор слотов по районам.
3. **Настройки подписки**
   - Управление текущими подписками, статусы, пропуски.
4. **Гостевой → регистрация**
   - Предложение создать пароль после оплаты.

### Бэкенд/Админка
- Расширить API ЛК: `GET/POST /addresses`, `GET /orders`, `POST /orders/repeat`.
- Админ панель: календарь недель, пресеты, лимиты, аллергенные теги, зоны и слоты.

---

# Архитектурные решения и TODO

## Данные и доменные модели (ядро)
- Новые сущности:
  - `MenuWeek`, `DayOffer` (калории, аллергенные теги, бейджи).
  - `Preset` (описание, дни, дефолт порции, скидка).
  - `OrderTemplate` / `WeekSelection` (многонедельная корзина).
  - `Subscription`, `SubscriptionWeek`, `PaymentIntent`, `PaymentToken`.
  - `DeliveryZone`, `DeliverySlot`, `Address`.
  - `AllergyTag`, связь с пользователем.
- Общая схема: Week → DayOffer → OrderItem; Preset → DaySelection; Subscription → ScheduledCharge.

## API слои
- `/menu/week` + `/menu/weeks` (готово). Добавить `/menu/presets`, `/menu/week/:id` при необходимости.
- `/orders/calc` — расчёт корзины.
- `/orders/checkout` — оформление (режим единоразового / многонедельного / подписка).
- `/subscriptions/*` — управление подпиской.
- `/addresses`, `/delivery/slots` — адреса и слоты.
- Гостевой вход: `/auth/guest/start` (телефон), `/auth/guest/confirm` (SMS код).

## Frontend архитектура
- Переписать `order/new` → `planner` (новый экран):
  - Zustand/Context для состояния корзины (выбранные дни, порции, пресет, недельность, подписка).
  - React Query слои для меню, пресетов, недель, заказа.
  - Sticky layout + responsive сетка (Tailwind + CSS Grid).
- Чек-аут: общая форма, интеграция с платежами (Stripe/CloudPayments и т.п.).
- ЛК: отдельный layout, вкладки «Заказы», «Адреса», «Подписки».

## Платежи и уведомления
- Выбрать провайдера (Stripe/CloudPayments/WayForPay). Добавить webhooks для подтверждений.
- SMS/email сервис (SendGrid/Twilio/локальный). Вынести уведомления в celery/worker.

## Интеграции и config
- Дедлайны, лимиты, пресеты, зоны — в админке, хранение в БД (таблицы `settings`/`delivery_zone`).
- Аллергены — обязательные теги в `DayOffer`, сверка с профилем пользователя при добавлении дня.

## Аналитика
- Инструмент: Amplitude/Mixpanel или собственный сбор. События: просмотр планировщика, выбор пресета, запуск оплаты, успешная оплата, ошибки.
- Встроить GTM/GA4, события для A/B тестов (пресет по умолчанию, позиция сводки и т.п.).

## A/B тесты
- Поддержка флагов (LaunchDarkly/наша таблица feature_flags). Эксперименты из блока «A/B гипотезы» — реализовать переключатели в UI.

## Безопасность и производительность
- Сохранение состояния на клиенте (localStorage) и сервере (черновик заказа) на случай перезагрузки.
- Кэширование меню/пресетов (React Query + server caching).
- PCI DSS — токены карт у провайдера, не хранить PAN/CSC.

---

Этот документ — источник правды по roadmap/архитектуре. Файл хранится в репозитории и будет дополняться при детализации каждой итерации.
