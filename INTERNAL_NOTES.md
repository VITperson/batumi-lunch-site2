# Internal Notes

## Mapping: Telegram Bot ‚Üí Web Pages & Endpoints

| Bot command / intent | Web page | Backend endpoint(s) | Notes |
| --- | --- | --- | --- |
| `/start`, `üîÑ –í –Ω–∞—á–∞–ª–æ` | `/` (landing) | `GET /menu/week`, `GET /menu/presets` | –ü–æ–∫–∞–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –Ω–µ–¥–µ–ª–∏, CTA –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫. |
| `–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é` | `/menu` | `GET /menu/week`, `GET /menu/weeks` | –¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ñ–æ—Ç–æ –∏ fallback –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –º–µ–Ω—é. |
| `–ó–∞–∫–∞–∑–∞—Ç—å –æ–±–µ–¥` (wizard: –¥–µ–Ω—å ‚Üí –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üí –∞–¥—Ä–µ—Å ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ) | `/planner` (–Ω–µ–¥–µ–ª—è) –∏ `/checkout` | `POST /orders/calc`, `POST /orders/checkout`, `GET /addresses`, `POST /addresses`, `POST /auth/guest/*` | –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–µ–¥–µ–ª–∏ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—ã–±–æ—Ä –¥–Ω—è/–ø–æ—Ä—Ü–∏–π; checkout –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–¥—Ä–µ—Å –∏ –æ–ø–ª–∞—Ç—É. |
| –î—É–±–ª–∏–∫–∞—Ç –∑–∞–∫–∞–∑–∞ (`resolve_duplicate_order`) | `/planner` (–¥–∏–∞–ª–æ–≥), `/account/orders/{id}` | `POST /orders/calc` (–≤–∞–ª–∏–¥–∞—Ü–∏—è), `PATCH /orders/{id}`, `POST /orders/{id}/cancel` | –ù—É–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫–∞–∑ –∏ –Ω–æ–≤—ã–π, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É–≤–µ–ª–∏—á–∏—Ç—å –∏–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å. |
| `–ú–æ–∏ –∑–∞–∫–∞–∑—ã` (`list_active_orders`) | `/account/orders` | `GET /orders?mine=1`, `PATCH /orders/{id}`, `POST /orders/{id}/cancel` | –°—Ç–∞—Ç—É—Å—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞–∫ –≤ –±–æ—Ç–µ. |
| `/order <ID>` | `/orders/{id}` | `GET /orders/{id}` | –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏. |
| `/cancel <ID>` –∏–ª–∏ inline –æ—Ç–º–µ–Ω–∞ | `/orders/{id}` | `POST /orders/{id}/cancel` | –°—Ç–∞—Ç—É—Å—ã `cancelled_by_user` –∏–ª–∏ `cancelled` (–∞–¥–º–∏–Ω). |
| –ê–¥–º–∏–Ω –º–µ–Ω—é (`admin_manage_menu`) | `/admin/menu` | `PUT /admin/menu/week`, `PUT /admin/menu/{day}`, `POST /admin/menu/photo` | CRUD –Ω–µ–¥–µ–ª—å –∏ –±–ª—é–¥, –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ. |
| –ê–¥–º–∏–Ω –æ—Ç—á—ë—Ç—ã (`admin_report_*`) | `/admin/reports` | `GET /orders?week=...`, `GET /menu/week` | –î–∞—à–±–æ—Ä–¥ –ø–æ –Ω–µ–¥–µ–ª—è–º/–¥–Ω—è–º. |
| `/sms` —Ä–∞—Å—Å—ã–ª–∫–∞ | `/admin/broadcast` | `POST /admin/broadcasts` | –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º. |
| –ü—Ä–æ—Ñ–∏–ª—å (`my_profile`) | `/account/profile` (—á–∞—Å—Ç—å –õ–ö) | `GET /addresses`, `GET /orders` | –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞/—Ç–µ–ª–µ—Ñ–æ–Ω–∞. |
| –ö–æ–Ω—Ç–∞–∫—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (`contact_operator`) | `/support` (–º–æ–¥–∞–ª–∫–∞/—Å–µ–∫—Ü–∏—è) | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç | –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω/Instagram. |

## Business Rules & Validation (–∏–∑ `bot.py`)

- **–ú–µ–Ω—é –∏ –Ω–µ–¥–µ–ª–∏**
  - –ú–µ–Ω—é —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø–æ –Ω–µ–¥–µ–ª—è–º (`menu.json`): –∫–ª—é—á `week` + –∫–∞—Ä—Ç–∞ `–¥–µ–Ω—å ‚Üí –±–ª—é–¥–∞`. –§–æ—Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –ø–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—É—Ç—è–º `DishPhotos/<Day>.png`.
  - –û–∫–Ω–æ –∑–∞–∫–∞–∑–æ–≤ –∑–∞–¥–∞—ë—Ç—Å—è `order_window.json`: –ø–æ–ª—è `next_week_enabled` –∏ `week_start` (ISO). –ï—Å–ª–∏ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ, –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è.
  - `_is_day_available_for_order(day)` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –î–µ–Ω—å –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –º–µ–Ω—é.
    - –ï—Å–ª–∏ –¥–µ–Ω—å —É–∂–µ –ø—Ä–æ—à—ë–ª –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏, –Ω–æ —Å–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è –æ—Ç–∫—Ä—ã—Ç–∞ –∏ `week_start` –≤ –±—É–¥—É—â–µ–º ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–∞–∫ –∑–∞–∫–∞–∑ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é.
    - –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–µ–¥–ª–∞–π–Ω `ORDER_CUTOFF_HOUR = 10` (–ø–æ –º–µ—Å—Ç–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏).
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–ª–∞–≥–∏ `is_next_week` –∏ ISO –¥–∞—Ç—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤.

- **–õ–∏–º–∏—Ç—ã –∏ –∞–Ω—Ç–∏—Å–ø–∞–º**
  - –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä `1-4` (—Å—Ç—Ä–æ–∫–∏ "1 –æ–±–µ–¥" ... "4 –æ–±–µ–¥–∞"); –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–≤–æ–¥–∏—Ç—å —Ü–∏—Ñ—Ä—ã `1-4`.
  - –ê–Ω—Ç–∏—Å–ø–∞–º: –Ω–µ–ª—å–∑—è –æ—Ñ–æ—Ä–º–ª—è—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 10 —Å–µ–∫—É–Ω–¥ (`last_order_ts`).

- **–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
  - `users.json` —Ö—Ä–∞–Ω–∏—Ç `address`, `phone`. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–∫–∞–∑–µ –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è, –¥–∞–ª–µ–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è.
  - –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ ‚Äî —Ç–µ–∫—Å—Ç —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º—ã; –±–æ—Ç –ø—Ä–æ—Å–∏—Ç –∞–¥—Ä–µ—Å –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏.
  - –¢–µ–ª–µ—Ñ–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º; –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ ¬´–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å¬ª.

- **–ó–∞–∫–∞–∑—ã**
  - `orders.json` —Ö—Ä–∞–Ω–∏—Ç `user_id`, `day`, `count`, `menu`, `address`, `phone`, `status`, `created_at`, `delivery_week_start`, `next_week`.
  - ID –∑–∞–∫–∞–∑–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `BLB-<ts36>-<uid36>-<rnd>`.
  - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:
    - –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –¥–Ω—è/–ø–æ—Ä—Ü–∏–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç —á–µ—Ä–µ–∑ `find_user_order_same_day(uid, day, week_start)`.
    - –ï—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç –Ω–∞–π–¥–µ–Ω, –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—è: —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å, –æ—Ç–º–µ–Ω–∏—Ç—å (—Å–º. `resolve_duplicate_order`).
    - –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∑–∞–∫–∞–∑ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `new`, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ç–æ–∏–º–æ—Å—Ç—å = `count * PRICE_LARI (15)`.
    - –ê–¥–º–∏–Ω—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–∫–∞–∑–∞.
  - –û—Ç–º–µ–Ω–∞: `set_order_status(order_id, new_status)` –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ `status`. –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ç—É—Å—ã `cancelled_by_user`, `cancelled`.
  - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: –ø–æ—Ç–æ–∫ `update_order_count_choice` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–º–µ–Ω—è—Ç—å `count` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–æ–≤.

- **–ê–¥–º–∏–Ω-–ø–æ—Ç–æ–∫–∏**
  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é: CRUD –ø–æ –¥–Ω—è–º/–Ω–µ–¥–µ–ª–µ, –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–∫–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏.
  - –û—Ç—á—ë—Ç—ã: –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞–º.
  - –†–∞—Å—Å—ã–ª–∫–∏: `/sms <HTML>` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–∫—Ä–æ–º–µ –∞–¥–º–∏–Ω–∞) –∏–∑ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ `users.json` –∏ `orders.json`.

- **–ü—Ä–æ—á–µ–µ**
  - –õ–æ–≥–∏ –≤–µ–¥—É—Ç—Å—è —á–µ—Ä–µ–∑ `TimedRotatingFileHandler` –∏ –∫–æ–Ω—Å–æ–ª—å.
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `PicklePersistence` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π (`bot_state.pickle`).
  - –ö–æ–Ω—Ç–∞–∫—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω, Instagram, username) –±–µ—Ä—É—Ç—Å—è –∏–∑ `config_secret.py` —Å –∑–∞–ø–∞—Å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.

## UX —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–∑ roadmap

- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–µ–¥–µ–ª–∏ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–Ω–µ–π: –¥–æ—Å—Ç—É–ø–µ–Ω, sold-out, –∑–∞–∫—Ä—ã—Ç –ø–æ –¥–µ–¥–ª–∞–π–Ω—É. –ù–∞–¥–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å API `DayOffer` –ø–æ–ª—è–º–∏ `status`, `portion_limit`, `allergy_tags`.
- Sticky summary: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–Ω–∏, –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–π –ø—Ä–µ—Å–µ—Ç, –ø—Ä–æ–º–æ–∫–æ–¥, –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å.
- –ì–æ—Å—Ç–µ–≤–æ–π —á–µ–∫-–∞—É—Ç: —Ç–µ–ª–µ—Ñ–æ–Ω + SMS –∫–æ–¥ ‚Üí `/auth/guest/start` –∏ `/auth/guest/confirm`.
- –ú–Ω–æ–≥–æ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∑–∞–∫–∞–∑: —Å—á—ë—Ç—á–∏–∫ –Ω–µ–¥–µ–ª—å 1‚Äì8, –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–Ω–µ–π (`OrderTemplate`, `WeekSelection`).
- –ü–æ–¥–ø–∏—Å–∫–∏: —Å—É—â–Ω–æ—Å—Ç–∏ `Subscription`, `SubscriptionWeek`, `PaymentIntent`, `PaymentToken`; —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–º–∏ –∏ –ø–∞—É–∑–∞–º–∏.
- –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç: –≤–∫–ª–∞–¥–∫–∏ ¬´–ó–∞–∫–∞–∑—ã¬ª, ¬´–ê–¥—Ä–µ—Å–∞¬ª, ¬´–ü–æ–¥–ø–∏—Å–∫–∏¬ª, –∫–Ω–æ–ø–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞.
- –ê–¥–º–∏–Ω–∫–∞: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é, –ø—Ä–µ—Å–µ—Ç–∞–º–∏, –ª–∏–º–∏—Ç–∞–º–∏, –∑–æ–Ω–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏, –æ—Ç—á—ë—Ç–∞–º–∏.

## –î–æ–º–µ–Ω–Ω—ã–µ TODO –¥–ª—è Web

- –¢–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª—É cutoff/next_week –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –∫–æ—Ä–∑–∏–Ω—ã (`/orders/calc`).
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –≤ API (409 + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏), —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –∑–∞–∫–∞–∑–∞.
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤/—Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ (—Ñ–æ—Ä–º–∞—Ç, –∑–æ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏).
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤ (`new`, `cancelled_by_user`, `cancelled`, –±—É–¥—É—â–∏–µ `confirmed`, `delivered`).
- –†–∞—Å—à–∏—Ä—è–µ–º—ã–µ –ª–∏–º–∏—Ç—ã –ø–æ—Ä—Ü–∏–π/–¥–Ω–µ–π —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.

